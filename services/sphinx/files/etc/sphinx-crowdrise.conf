#
# Minimal Sphinx configuration sample (clean, simple, functional)
#

##
# Charities Source
##
source charitiesSource {

        type     = mysql
        sql_host = 10.223.176.244
        sql_user = crowdrise_user
        sql_pass = m0nK3YbRa1nz
        sql_db   = crowdrise
        sql_port = 3306

	sql_query = SELECT charities.id, charities.username, charities.about, charities.name, \
		    charities.city, charities.state \
		    FROM charities

	sql_field_string = name
	sql_field_string = username 
	sql_field_string = about
	sql_field_string = city
	sql_field_string = state
}

##
# Volunteers
##
source volunteersSource{

        type     = mysql
        sql_host = 10.223.176.244
        sql_user = crowdrise_user
        sql_pass = m0nK3YbRa1nz
        sql_db   = crowdrise
        sql_port = 3306

	sql_query = SELECT users.id, users.username, users.email, meta.first_name, meta.last_name, \
		    CONCAT(meta.first_name,' ', meta.last_name) AS full_name, meta.points, meta.about, \
		    countries.country, meta.region AS state, meta.city, CRC32(meta.charity_id) AS where_charity_id, \
		    CRC32(meta.organization) AS where_organization, \
		    REPLACE(REPLACE(users.email, '.', ' '), '@', ' ') AS clean_email \
		    FROM users \
		    INNER JOIN meta ON meta.user_id = users.id \
		    LEFT OUTER JOIN countries ON countries.id = meta.country \

	sql_field_string = username
	sql_field_string = email
	sql_field_string = full_name
	sql_field_string = first_name
	sql_field_string = last_name
	sql_field_string = about
	sql_field_string = country
	sql_field_string = state
	sql_field_string = city

	#used for searching cleaned/stripped out cahracters words. 
	sql_field_string = clean_email  

	sql_attr_uint  = where_organization
	sql_attr_uint  = where_charity_id
}

##
# Campaigns
##
source campaignsSource {

        type     = mysql
        sql_host = 10.223.176.244
        sql_user = crowdrise_user
        sql_pass = m0nK3YbRa1nz
        sql_db   = crowdrise
        sql_port = 3306

	sql_query = SELECT campaigns.id, campaigns.username, campaigns.name, campaigns.hidden, \
		    campaigns.about, UNIX_TIMESTAMP(campaigns.event_date) as event_date, campaigns.deadline, \
		    CRC32(campaigns.hidden) AS where_hidden, UNIX_TIMESTAMP(campaigns.created) as created \
		    FROM campaigns

	sql_field_string = username
	sql_field_string = name
	sql_field_string = about
	sql_field_string = deadline

	sql_attr_uint  = where_hidden
	sql_attr_timestamp = created
	sql_attr_timestamp  = event_date


}

##
# Charity Organizations
##
source charityOrganizationsSource {

        type     = mysql
        sql_host = 10.223.176.244
        sql_user = crowdrise_user
        sql_pass = m0nK3YbRa1nz
        sql_db   = crowdrise
        sql_port = 3306

	sql_query = SELECT charities.id, charities.username, charities.name, meta.about, \
		    charities.name AS first_name, '' AS last_name, charities.raised AS points, \
		    charities.state AS state, '' AS country, charities.city, \
		    CRC32(meta.organization) AS where_organization \
		    FROM charities \
		    LEFT JOIN meta ON meta.charity_id = charities.id

	sql_field_string = username
	sql_field_string = name
	sql_field_string = about
	sql_field_string = first_name
	sql_field_string = last_name
	sql_field_string = points
	sql_field_string = state
	sql_field_string = country
	sql_field_string = city
		
	sql_attr_uint = where_organization


}


##
# User Organization 
##
source userOrganizationsSource {


        type     = mysql
        sql_host = 10.223.176.244
        sql_user = crowdrise_user
        sql_pass = m0nK3YbRa1nz
        sql_db   = crowdrise
        sql_port = 3306
	
	sql_query 	= SELECT users.id AS user_id, users.username as username, meta.first_name as first_name, \
			  meta.last_name as last_name, CONCAT(meta.first_name, meta.last_name) as full_name, \
			  meta.points as points, meta.about as about, countries.country as country, \
			  meta.region as state, meta.city as city, meta.charity_id, meta.organization, \
			  CRC32(meta.charity_id) AS where_charity_id, CRC32(meta.organization) AS where_organization \
			  FROM users \
			  INNER JOIN meta on meta.user_id = users.id \
			  LEFT OUTER JOIN countries ON countries.id = meta.country

	sql_field_string = full_name
	sql_field_string = username
	sql_field_string = last_name
	#sql_field_string = points
	sql_field_string = about
	sql_field_string = country
	sql_field_string = state
	sql_field_string = city
	sql_field_string = first_name
	sql_field_string = charity_id
	sql_field_string = organization        

	sql_attr_uint = where_charity_id
	sql_attr_uint = where_organization 
	

}

source projectsSource {


        type     = mysql
        sql_host = 10.223.176.244
        sql_user = crowdrise_user
        sql_pass = m0nK3YbRa1nz
        sql_db   = crowdrise
        sql_port = 3306

	sql_query = SELECT projects.id, fundraisers.username, fundraisers.name, fundraisers.total_raised, \
		    fundraisers.total_offline, fundraisers.open_join, fundraisers.registrant_first_name, \
		    fundraisers.registrant_last_name, \
		    fundraisers.hidden, fundraisers.is_ffa, fundraisers.coregistrant_first_name, \
		    fundraisers.coregistrant_last_name, fundraisers.deadline, fundraisers.event_id, \
		    fundraisers.require_share, meta.first_name, meta.last_name, meta.city, meta.region AS state, \
		    meta.zip, projects.latest_activity, projects.owner_id, projects.owner_type, projects.goal, \
		    projects.raised, projects.about, charities.name AS charity_name, charities.featured, \
		    charities.featured_expiration, \
		    CRC32(fundraisers.open_join) AS where_open_join, \
		    CRC32(projects.organizer) AS where_organizer, \
		    CRC32(projects.hidden) AS where_hidden, \
		    CRC32(projects.owner_type) AS where_owner_type, \
                    CRC32(fundraisers.is_ffa) AS where_is_ffa \
		    FROM projects \
		    LEFT JOIN fundraisers ON fundraisers.id = projects.fundraiser_id \
		    LEFT JOIN charities ON charities.id = fundraisers.charity_id \
		    LEFT JOIN meta ON meta.user_id = projects.owner_id 
	
	sql_field_string  = name
	sql_field_string  = registrant_first_name
	sql_field_string  = registrant_last_name
	sql_field_string  = coregistrant_first_name
	sql_field_string  = coregistrant_last_name
	sql_field_string  = first_name
	sql_field_string  = last_name
	sql_field_string  = city
	sql_field_string  = state 
	sql_field_string  = zip
	sql_field_string  = charity_name

	sql_attr_string		= about
	sql_attr_string 	= featured
	sql_attr_string 	= featured_expiration
	sql_attr_string 	= raised
	sql_attr_string 	= owner_id
	sql_attr_string 	= owner_type
	sql_attr_string 	= goal 
	sql_attr_string		= deadline 	
	sql_attr_string 	= hidden
	sql_attr_string 	= open_join
	sql_attr_string 	= total_offline
	sql_attr_string 	= total_raised
	sql_attr_string		= username
	sql_attr_uint           = where_is_ffa
        sql_attr_uint           = where_owner_type
	sql_attr_uint		= where_open_join
	sql_attr_uint		= where_organizer
	sql_attr_uint           = where_hidden
	sql_attr_uint		= event_id
	sql_attr_timestamp 	= latest_activity


}	


index userOrganizationIndex {
	type 		= plain
	source 		= userOrganizationsSource
	path 		= /usr/local/sphinx/var/data/user_organizations
	preopen 	= 1

	morphology = stem_en
}

index charityOrganizationsIndex {

	type = plain
	source = charityOrganizationsSource
	path = /usr/local/sphinx/var/data/charity_organization
	preopen = 1

	morphology = stem_en
}


index volunteersIndex {

	type = plain
	source = volunteersSource
	path = /usr/local/sphinx/var/data/volunteers
	preopen = 1

	#Turn on fuzzy searching. Below is "sounds like"
    	morphology   = stem_en
}

index charitiesIndex {

	type = plain
	source = charitiesSource
	path = /usr/local/sphinx/var/data/charities
	preopen = 1	

	morphology = stem_en
}

index projectsIndex {
	
	type = plain
	source = projectsSource
	path = /usr/local/sphinx/var/data/projects
	preopen = 1

	morphology = stem_en

}

index campaignsIndex {

	type = plain
	source = campaignsSource
	path = /usr/local/sphinx/var/data/campaigns
	preopen = 1

	morphology = stem_en

}

indexer
{
	mem_limit		= 128M 
}

###
# Sphinx config options.
##
searchd
{
	listen			= 9312
	listen			= 9306:mysql41
	log			= /usr/local/sphinx/var/log/searchd.log
	query_log		= /usr/local/sphinx/var/log/query.log
	read_timeout		= 5
	max_children		= 30
	pid_file		= /usr/local/sphinx/var/log/searchd.pid
	seamless_rotate		= 1
	preopen_indexes		= 1
	unlink_old		= 1
	workers			= threads # for RT to work
	binlog_path		= /usr/local/sphinx/var/data
}
